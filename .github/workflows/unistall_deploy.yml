name: Uninstall Deploy

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: choice
        description: Select the Environment
        options:
          - dev
          - uat
          - prod
      is_canary:
        type: boolean
        description: Uninstall the canary version on AKS
        default: true


permissions:
  packages: write
  contents: write
  issues: write
  id-token: write
  actions: read


# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.get_env.outputs.environment }}
    steps:
      # Set Environment
      - run: echo "ENVIRNOMENT=${{ inputs.environment}}" >> $GITHUB_ENV

      - if: ${{ inputs.environment == null }}
        run: echo "ENVIRNOMENT=dev" >> $GITHUB_ENV

      - id: get_env
        name: Set Output
        run: echo "environment=${{env.ENVIRNOMENT}}" >> $GITHUB_OUTPUT

  remove_deploy_dry_run:
    needs: [ setup ]
    runs-on: [ self-hosted-job, "${{ inputs.environment }}" ]
    name: ğŸ—‘Remove deployment dry run
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          ref: ${{ inputs.branch}}

      - name: Login
        uses: azure/login@89d153571fe9a34ed70fcf9f1d95ab8debea7a73
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENANT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

      - name: Gets K8s context
        uses: azure/aks-set-context@4edaee69f820359371ee8bc85189ac03a21d3a58 # v3
        with:
          resource-group: ${{ vars.CLUSTER_RESOURCE_GROUP }}
          cluster-name: ${{ vars.CLUSTER_NAME }}
          admin: 'false'
          use-kubelogin: 'true'

      - name: ğŸ› ï¸ Helm configure repos
        shell: bash
        run: |
          helm repo add microservice-chart https://pagopa.github.io/aks-microservice-chart-blueprint
          helm dep build helm
          echo "âœ… aks blueprint configured"

      - name: ğŸ—‘Remove deployment with dry run
        shell: bash
        env:
          APP_NAME: ${{ inputs.app_name }}
          SUFFIX_NAME: ${{ inputs.suffix_name }}
          NAMESPACE: ${{ inputs.namespace }}
        run: |
          echo "ğŸ—‘Launch helm uninstall"
          helm uninstall '${{ env.APP_NAME }}${{ env.SUFFIX_NAME }}' -n "$NAMESPACE" --dry-run
          echo "âœ”ï¸Helm uninstall"

  confirm-remove-deploy:
    needs: [ remove_deploy_dry_run ]
    runs-on: [ self-hosted-job, "${{ inputs.environment }}" ]
    name: ğŸ—‘Confirm remove deployment 
    environment: ${{ inputs.environment }}
    steps:
      - name: ğŸ—‘Remove deployment
        shell: bash
        env:
          APP_NAME: ${{ inputs.app_name }}
          SUFFIX_NAME: ${{ inputs.suffix_name }}
          NAMESPACE: ${{ inputs.namespace }}
        run: |
          echo "ğŸ—‘Launch helm uninstall"
          helm uninstall '$APP_NAME$SUFFIX_NAME' -n "$NAMESPACE"
          echo "âœ”ï¸Helm uninstall"

  notify:
    needs: [ setup, remove_deploy_dry_run, confirm-remove-deploy ]
    runs-on: ubuntu-latest
    name: Notify
    if: always()
    steps:
      - name: Report Status
        if: ${{ needs.setup.outputs.environment == 'prod' }}
        uses: ravsamhq/notify-slack-action@be814b201e233b2dc673608aa46e5447c8ab13f2 # v2
        with:
          status: ${{ needs.deploy_aks.result }}
          token: ${{ secrets.GITHUB_TOKEN }}
          notification_title: 'Delete Release on Production ${{ needs.release.outputs.version }} has {status_message}'
          message_format: '{emoji} <{run_url}|{workflow}> {status_message} in <{repo_url}|{repo}>'
          footer: 'Linked to <{workflow_url}| workflow file>'
          icon_success: ':wastebasket:'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
