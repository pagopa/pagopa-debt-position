<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PaymentPositionService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Coverage Report</a> &gt; <a href="../index.html" class="el_bundle">gpd</a> &gt; <a href="index.source.html" class="el_package">it.gov.pagopa.debtposition.service</a> &gt; <span class="el_source">PaymentPositionService.java</span></div><h1>PaymentPositionService.java</h1><pre class="source lang-java linenums">package it.gov.pagopa.debtposition.service;

import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.Optional;

import javax.validation.Valid;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Positive;

import org.hibernate.exception.ConstraintViolationException;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Transactional;

import it.gov.pagopa.debtposition.entity.PaymentOption;
import it.gov.pagopa.debtposition.entity.PaymentPosition;
import it.gov.pagopa.debtposition.entity.Transfer;
import it.gov.pagopa.debtposition.exception.AppError;
import it.gov.pagopa.debtposition.exception.AppException;
import it.gov.pagopa.debtposition.exception.ValidationException;
import it.gov.pagopa.debtposition.model.enumeration.DebtPositionStatus;
import it.gov.pagopa.debtposition.model.enumeration.PaymentOptionStatus;
import it.gov.pagopa.debtposition.model.enumeration.TransferStatus;
import it.gov.pagopa.debtposition.model.filterandorder.FilterAndOrder;
import it.gov.pagopa.debtposition.model.pd.PaymentPositionModel;
import it.gov.pagopa.debtposition.repository.PaymentPositionRepository;
import it.gov.pagopa.debtposition.repository.specification.PaymentPositionByDueDate;
import it.gov.pagopa.debtposition.repository.specification.PaymentPositionByIUPD;
import it.gov.pagopa.debtposition.repository.specification.PaymentPositionByOrganizationFiscalCode;
import it.gov.pagopa.debtposition.util.CommonUtil;
import it.gov.pagopa.debtposition.validation.DebtPositionValidation;
import lombok.extern.slf4j.Slf4j;


@Service
<span class="fc" id="L45">@Slf4j</span>
<span class="fc" id="L46">public class PaymentPositionService {</span>

	private static final String UNIQUE_KEY_VIOLATION = &quot;23505&quot;;
	@Autowired
	private PaymentPositionRepository paymentPositionRepository;
	@Autowired
	private ModelMapper modelMapper;


	public PaymentPosition create (@NotNull PaymentPosition debtPosition, @NotBlank String organizationFiscalCode) {

<span class="fc" id="L57">		final String ERROR_CREATION_LOG_MSG = &quot;Error during debt position creation: %s&quot;;</span>

		try {

			// verifico la correttezza dei dati in input
<span class="fc" id="L62">			DebtPositionValidation.checkPaymentPositionInputDataAccurancy(debtPosition);</span>

			// predispongo i dati ad uso interno prima dell'aggiornamento
<span class="fc" id="L65">			LocalDateTime currentDate = LocalDateTime.now(ZoneOffset.UTC);</span>
<span class="fc" id="L66">			debtPosition.setInsertedDate(currentDate);</span>
<span class="fc" id="L67">			debtPosition.setLastUpdatedDate(currentDate);</span>
<span class="fc" id="L68">			debtPosition.setOrganizationFiscalCode(organizationFiscalCode);</span>
<span class="fc" id="L69">			debtPosition.setStatus(DebtPositionStatus.DRAFT);</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">			for (PaymentOption po : debtPosition.getPaymentOption()) {</span>
<span class="fc" id="L71">				po.setOrganizationFiscalCode(organizationFiscalCode);</span>
<span class="fc" id="L72">				po.setInsertedDate(currentDate);</span>
<span class="fc" id="L73">				po.setLastUpdatedDate(currentDate);</span>
<span class="fc" id="L74">				po.setStatus(PaymentOptionStatus.PO_UNPAID);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">				for (Transfer t: po.getTransfer()) {</span>
<span class="fc" id="L76">					t.setOrganizationFiscalCode(organizationFiscalCode);</span>
<span class="fc" id="L77">					t.setInsertedDate(currentDate);</span>
<span class="fc" id="L78">					t.setLastUpdatedDate(currentDate);</span>
<span class="fc" id="L79">					t.setStatus(TransferStatus.T_UNREPORTED);</span>
<span class="fc" id="L80">				}</span>
<span class="fc" id="L81">			}</span>

			// Inserisco la posizione debitoria
<span class="fc" id="L84">			return paymentPositionRepository.saveAndFlush(debtPosition);</span>

<span class="fc" id="L86">		} catch (DataIntegrityViolationException e) {</span>
<span class="fc" id="L87">			log.error(String.format(ERROR_CREATION_LOG_MSG,e.getMessage()), e);</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">			if (e.getCause() instanceof ConstraintViolationException) {</span>
<span class="fc" id="L89">				String sqlState = ((ConstraintViolationException) e.getCause()).getSQLState();</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">				if (sqlState.equals(UNIQUE_KEY_VIOLATION)) {</span>
<span class="fc" id="L91">					throw new AppException(AppError.DEBT_POSITION_ALREADY_EXIST, organizationFiscalCode);</span>
				}
			}
<span class="nc" id="L94">			throw new AppException(AppError.DEBT_POSITION_CREATION_FAILED, organizationFiscalCode);</span>
<span class="fc" id="L95">		} catch (ValidationException e) {</span>
<span class="fc" id="L96">			throw new AppException(AppError.DEBT_POSITION_REQUEST_DATA_ERROR, e.getMessage());</span>
<span class="nc" id="L97">		} catch (Exception e) {</span>
<span class="nc" id="L98">			log.error(String.format(ERROR_CREATION_LOG_MSG,e.getMessage()), e);</span>
<span class="nc" id="L99">			throw new AppException(AppError.DEBT_POSITION_CREATION_FAILED, organizationFiscalCode);</span>
		}
	}

	public PaymentPosition getDebtPositionByIUPD (String organizationFiscalCode,
			String iupd) {

<span class="fc" id="L106">		Specification&lt;PaymentPosition&gt; spec = Specification.where(</span>
				new PaymentPositionByOrganizationFiscalCode(organizationFiscalCode)
<span class="fc" id="L108">				.and(new PaymentPositionByIUPD(iupd))</span>
				);

<span class="fc" id="L111">		Optional&lt;PaymentPosition&gt; pp = paymentPositionRepository.findOne(spec);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">		if (pp.isEmpty()) {</span>
<span class="fc" id="L113">			throw new AppException(AppError.DEBT_POSITION_NOT_FOUND, organizationFiscalCode, iupd);</span>
		}

<span class="fc" id="L116">		return pp.get();</span>
	}

	public Page&lt;PaymentPosition&gt; getOrganizationDebtPositions (@Positive Integer limit, @Positive Integer pageNum, FilterAndOrder filterAndOrder){

<span class="fc" id="L121">		Pageable pageable = PageRequest.of(pageNum, limit, CommonUtil.getSort(filterAndOrder));</span>

<span class="fc" id="L123">		Specification&lt;PaymentPosition&gt; spec = Specification.where(</span>
<span class="fc" id="L124">				new PaymentPositionByOrganizationFiscalCode(filterAndOrder.getFilter().getOrganizationFiscalCode())</span>
<span class="fc" id="L125">				.and(new PaymentPositionByDueDate(</span>
<span class="fc" id="L126">						filterAndOrder.getFilter().getDueDateFrom(),</span>
<span class="fc" id="L127">						filterAndOrder.getFilter().getDueDateTo())));</span>

<span class="fc" id="L129">		return paymentPositionRepository.findAll(spec, pageable);</span>

	}

	@Transactional(isolation = Isolation.SERIALIZABLE)
	public void delete(@NotBlank String organizationFiscalCode, @NotBlank String iupd) {
<span class="fc" id="L135">		PaymentPosition ppToRemove = this.getDebtPositionByIUPD(organizationFiscalCode, iupd);</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">		if (DebtPositionStatus.getPaymentPosAlreadyPaidStatus().contains(ppToRemove.getStatus())){</span>
<span class="nc" id="L137">			throw new AppException(AppError.DEBT_POSITION_PAYMENT_FOUND, organizationFiscalCode, iupd);</span>
		}
<span class="fc" id="L139">		paymentPositionRepository.delete(ppToRemove);</span>
<span class="fc" id="L140">	}</span>


	@Transactional(isolation = Isolation.SERIALIZABLE)
	public PaymentPosition update(@NotNull @Valid PaymentPositionModel paymentPositionModel, @NotBlank String organizationFiscalCode) {

<span class="fc" id="L146">		PaymentPosition ppToUpdate = this.getDebtPositionByIUPD(organizationFiscalCode, paymentPositionModel.getIupd());</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">		if (DebtPositionStatus.getPaymentPosNotUpdatableStatus().contains(ppToUpdate.getStatus())){</span>
<span class="nc" id="L149">			throw new AppException(AppError.DEBT_POSITION_NOT_UPDATABLE, organizationFiscalCode, paymentPositionModel.getIupd());</span>
		}

		try {

			// flip model to entity 
<span class="fc" id="L155">			ppToUpdate.getPaymentOption().clear();</span>
<span class="fc" id="L156">			modelMapper.map(paymentPositionModel, ppToUpdate);</span>

			// verifico la correttezza dei dati in input
<span class="fc" id="L159">			DebtPositionValidation.checkPaymentPositionInputDataAccurancy(ppToUpdate);</span>

			// predispongo i dati ad uso interno prima dell'aggiornamento
<span class="fc" id="L162">			LocalDateTime currentDate = LocalDateTime.now(ZoneOffset.UTC);</span>
<span class="fc" id="L163">			ppToUpdate.setLastUpdatedDate(currentDate);</span>
<span class="fc" id="L164">			ppToUpdate.setStatus(DebtPositionStatus.DRAFT);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">			for (PaymentOption po : ppToUpdate.getPaymentOption()) {</span>
<span class="fc" id="L166">				po.setOrganizationFiscalCode(organizationFiscalCode);</span>
<span class="fc" id="L167">				po.setInsertedDate(ppToUpdate.getInsertedDate());</span>
<span class="fc" id="L168">				po.setLastUpdatedDate(currentDate);</span>
<span class="fc" id="L169">				po.setStatus(PaymentOptionStatus.PO_UNPAID);</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">				for (Transfer t: po.getTransfer()) {</span>
<span class="fc" id="L171">					t.setOrganizationFiscalCode(organizationFiscalCode);</span>
<span class="fc" id="L172">					t.setInsertedDate(ppToUpdate.getInsertedDate());</span>
<span class="fc" id="L173">					t.setLastUpdatedDate(currentDate);</span>
<span class="fc" id="L174">					t.setStatus(TransferStatus.T_UNREPORTED);</span>
<span class="fc" id="L175">				}</span>
<span class="fc" id="L176">			}</span>

<span class="fc" id="L178">			return paymentPositionRepository.saveAndFlush(ppToUpdate);</span>

<span class="fc" id="L180">		} catch (ValidationException e) {</span>
<span class="fc" id="L181">			throw new AppException(AppError.DEBT_POSITION_REQUEST_DATA_ERROR, e.getMessage());</span>
<span class="nc" id="L182">		} catch (Exception e) {</span>
<span class="nc" id="L183">			log.error(&quot;Error during debt position creation:&quot; + e.getMessage(), e);</span>
<span class="nc" id="L184">			throw new AppException(AppError.DEBT_POSITION_UPDATE_FAILED, organizationFiscalCode);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>