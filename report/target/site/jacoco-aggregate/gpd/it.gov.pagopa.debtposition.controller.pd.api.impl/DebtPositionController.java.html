<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DebtPositionController.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Coverage Report</a> &gt; <a href="../index.html" class="el_bundle">gpd</a> &gt; <a href="index.source.html" class="el_package">it.gov.pagopa.debtposition.controller.pd.api.impl</a> &gt; <span class="el_source">DebtPositionController.java</span></div><h1>DebtPositionController.java</h1><pre class="source lang-java linenums">package it.gov.pagopa.debtposition.controller.pd.api.impl;

import java.time.LocalDate;
import java.util.List;

import javax.validation.Valid;
import javax.validation.constraints.Positive;

import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Sort.Direction;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;

import it.gov.pagopa.debtposition.controller.pd.api.IDebtPositionController;
import it.gov.pagopa.debtposition.entity.PaymentPosition;
import it.gov.pagopa.debtposition.exception.AppError;
import it.gov.pagopa.debtposition.exception.AppException;
import it.gov.pagopa.debtposition.model.filterandorder.Filter;
import it.gov.pagopa.debtposition.model.filterandorder.FilterAndOrder;
import it.gov.pagopa.debtposition.model.filterandorder.Order;
import it.gov.pagopa.debtposition.model.filterandorder.Order.PaymentPositionOrder;
import it.gov.pagopa.debtposition.model.pd.PaymentPositionModel;
import it.gov.pagopa.debtposition.model.pd.PaymentPositionsInfo;
import it.gov.pagopa.debtposition.model.pd.response.PaymentPositionModelBaseResponse;
import it.gov.pagopa.debtposition.service.PaymentPositionService;
import it.gov.pagopa.debtposition.util.CommonUtil;
import it.gov.pagopa.debtposition.util.HttpStatusExplainMessage;
import it.gov.pagopa.debtposition.util.ObjectMapperUtils;
import lombok.extern.slf4j.Slf4j;


@Controller
<span class="fc" id="L36">@Slf4j</span>
<span class="fc" id="L37">public class DebtPositionController implements IDebtPositionController {</span>
	
	@Autowired
	private ModelMapper modelMapper;
	
	@Autowired
	private PaymentPositionService paymentPositionService;
	
	private static final String LOG_BASE_HEADER_INFO   = &quot;[RequestMethod: %s] - [ClassMethod: %s] - [MethodParamsToLog: %s]&quot;;
	private static final String LOG_BASE_PARAMS_DETAIL = &quot;organizationFiscalCode= %s; iupd= %s&quot;;
	
	@Override
	public ResponseEntity&lt;String&gt; createDebtPosition(String organizationFiscalCode,
			@Valid PaymentPositionModel paymentPositionModel) {
<span class="fc" id="L51">		log.info(String.format(LOG_BASE_HEADER_INFO,&quot;POST&quot;,&quot;createDebtPosition&quot;, String.format(LOG_BASE_PARAMS_DETAIL, organizationFiscalCode, paymentPositionModel.getIupd())));</span>
		
		// flip model to entity
<span class="fc" id="L54">	    PaymentPosition debtPosition = modelMapper.map(paymentPositionModel, PaymentPosition.class);</span>
		
<span class="fc" id="L56">	    PaymentPosition createdDebtPos = paymentPositionService.create(debtPosition, organizationFiscalCode);</span>
		
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">		if (null != createdDebtPos) {</span>
<span class="fc" id="L59">			return new ResponseEntity&lt;&gt;(HttpStatusExplainMessage.DEBT_POSITION_CREATED, HttpStatus.CREATED);</span>
		}
		
<span class="nc" id="L62">		throw new AppException(AppError.DEBT_POSITION_CREATION_FAILED, organizationFiscalCode);</span>
	}

	@Override
	public ResponseEntity&lt;PaymentPositionModelBaseResponse&gt; getOrganizationDebtPositionByIUPD(String organizationFiscalCode,
			String iupd) {
<span class="fc" id="L68">		log.info(String.format(LOG_BASE_HEADER_INFO,&quot;GET&quot;,&quot;getOrganizationDebtPositionByIUPD&quot;, String.format(LOG_BASE_PARAMS_DETAIL, organizationFiscalCode, iupd)));</span>
		
		// flip entity to model
<span class="fc" id="L71">	    PaymentPositionModelBaseResponse paymentPositionResponse = ObjectMapperUtils.map(</span>
<span class="fc" id="L72">				paymentPositionService.getDebtPositionByIUPD(organizationFiscalCode, iupd), </span>
				PaymentPositionModelBaseResponse.class);
		
<span class="fc" id="L75">		return new ResponseEntity&lt;&gt;(paymentPositionResponse, HttpStatus.OK);</span>
	}

	@Override
	public ResponseEntity&lt;PaymentPositionsInfo&gt; getOrganizationDebtPositions(String organizationFiscalCode,
			@Positive Integer limit, @Positive Integer page, LocalDate dueDateFrom, LocalDate dueDateTo, 
			PaymentPositionOrder orderBy, Direction ordering) {
<span class="fc" id="L82">		log.info(String.format(LOG_BASE_HEADER_INFO,&quot;GET&quot;,&quot;getOrganizationDebtPositions&quot;, String.format(LOG_BASE_PARAMS_DETAIL, organizationFiscalCode, &quot;N/A&quot;)));</span>
		
		// Create filter and order object
<span class="fc" id="L85">		FilterAndOrder filterOrder = FilterAndOrder.builder()</span>
<span class="fc" id="L86">                .filter(Filter.builder()</span>
<span class="fc" id="L87">                        .organizationFiscalCode(organizationFiscalCode)</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">                        .dueDateFrom(dueDateFrom != null ? dueDateFrom.atStartOfDay() : null)</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">                        .dueDateTo(dueDateTo != null ? dueDateTo.atStartOfDay() : null)</span>
<span class="fc" id="L90">                        .build())</span>
<span class="fc" id="L91">                .order(Order.builder()</span>
<span class="fc" id="L92">                        .orderBy(orderBy)</span>
<span class="fc" id="L93">                        .ordering(ordering)</span>
<span class="fc" id="L94">                        .build())</span>
<span class="fc" id="L95">                .build();</span>
		
		
<span class="fc" id="L98">		Page&lt;PaymentPosition&gt; pagePP = paymentPositionService.getOrganizationDebtPositions(limit, page, filterOrder);</span>
		
		// flip entity to model
<span class="fc" id="L101">		List&lt;PaymentPositionModelBaseResponse&gt; ppResponseList = ObjectMapperUtils.mapAll(</span>
<span class="fc" id="L102">				pagePP.toList(), </span>
				PaymentPositionModelBaseResponse.class);
		
<span class="fc" id="L105">		return new ResponseEntity&lt;&gt;(PaymentPositionsInfo.builder()</span>
<span class="fc" id="L106">        .ppBaseResponseList(ppResponseList)</span>
<span class="fc" id="L107">        .pageInfo(CommonUtil.buildPageInfo(pagePP))</span>
<span class="fc" id="L108">        .build(), </span>
        HttpStatus.OK);
		
		
	}

    @Override
    public ResponseEntity&lt;String&gt; deleteDebtPosition(String organizationFiscalCode, String iupd) {
    	
<span class="fc" id="L117">    	final String PARMAS_TO_LOG = &quot;organizationFiscalCode=&quot;+organizationFiscalCode+&quot;; iupd=&quot;+iupd;</span>
<span class="fc" id="L118">		log.info(String.format(LOG_BASE_HEADER_INFO,&quot;DELETE&quot;,&quot;deleteDebtPosition&quot;, PARMAS_TO_LOG));</span>
		
<span class="fc" id="L120">    	paymentPositionService.delete(organizationFiscalCode, iupd);</span>
<span class="fc" id="L121">        return new ResponseEntity&lt;&gt;(HttpStatusExplainMessage.DEBT_POSITION_DELETED, HttpStatus.OK);</span>
    }

	@Override
	public ResponseEntity&lt;String&gt; updateDebtPosition(String organizationFiscalCode, String iupd,
			@Valid PaymentPositionModel paymentPositionModel) {
<span class="fc" id="L127">		final String IUPD_VALIDATION_ERROR = &quot;IUPD mistmatch error: path variable IUPD [%s] and request body IUPD [%s] must be the same&quot;;</span>
		
<span class="fc" id="L129">		log.info(String.format(LOG_BASE_HEADER_INFO,&quot;PUT&quot;,&quot;updateDebtPosition&quot;, String.format(LOG_BASE_PARAMS_DETAIL, organizationFiscalCode, iupd)));</span>
		// verifico la congruenza di dati tra lo iupd path variable e lo iupd nel request body
<span class="fc bfc" id="L131" title="All 2 branches covered.">		if (!paymentPositionModel.getIupd().equals(iupd)) {</span>
<span class="fc" id="L132">			log.error(String.format(LOG_BASE_HEADER_INFO,&quot;PUT&quot;,&quot;updateDebtPosition&quot;,  String.format(LOG_BASE_PARAMS_DETAIL, organizationFiscalCode, iupd))+</span>
<span class="fc" id="L133">					&quot; : &quot;+ String.format(IUPD_VALIDATION_ERROR,iupd,paymentPositionModel.getIupd()));</span>
			
<span class="fc" id="L135">			throw new AppException(AppError.DEBT_POSITION_REQUEST_DATA_ERROR, String.format(IUPD_VALIDATION_ERROR,iupd,paymentPositionModel.getIupd()));</span>
		}
		
<span class="fc" id="L138">		PaymentPosition updatedDebtPos = paymentPositionService.update(paymentPositionModel, organizationFiscalCode);</span>
		
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">		if (null != updatedDebtPos) {</span>
<span class="fc" id="L141">			return new ResponseEntity&lt;&gt;(HttpStatusExplainMessage.DEBT_POSITION_UPDATED, HttpStatus.OK);</span>
		}
		
<span class="nc" id="L144">		throw new AppException(AppError.DEBT_POSITION_UPDATE_FAILED, organizationFiscalCode);</span>
		
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>